name: Deploy to Timeweb Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          SSH_PORT: ${{ secrets.SSH_PORT || '22' }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ env.SSH_PORT }}
          script: |
            set -e
            DEPLOY_PATH="${{ secrets.SSH_DEPLOY_PATH }}"
            if [ -z "$DEPLOY_PATH" ]; then
              DEPLOY_PATH="$HOME/eclipse-todolist-bot"
            fi
            echo "Deploying to: $DEPLOY_PATH"
            
            # Определяем URL репозитория
            GIT_REPO="${{ secrets.GIT_REPOSITORY_URL }}"
            if [ -z "$GIT_REPO" ]; then
              # Используем HTTPS формат (работает для публичных репозиториев без аутентификации)
              # Для приватных репозиториев укажите GIT_REPOSITORY_URL с SSH или HTTPS+токеном
              GIT_REPO="https://github.com/${{ github.repository }}.git"
            fi
            
            # Проверяем существование директории
            if [ ! -d "$DEPLOY_PATH" ]; then
              echo "Directory does not exist. Creating directory and cloning repository..."
              mkdir -p "$(dirname "$DEPLOY_PATH")"
              echo "Cloning repository from: $GIT_REPO"
              git clone "$GIT_REPO" "$DEPLOY_PATH" || {
                echo "Error: Failed to clone repository."
                if [[ "$GIT_REPO" == git@* ]]; then
                  echo "SSH clone failed. Make sure:"
                  echo "1. SSH key is configured on the server for GitHub access"
                  echo "2. Repository is accessible via SSH"
                else
                  echo "HTTPS clone failed. For private repositories:"
                  echo "1. Use SSH URL: git@github.com:username/repo.git (requires SSH key setup)"
                  echo "2. Or use HTTPS with token: https://USERNAME:TOKEN@github.com/username/repo.git"
                  echo "3. Or make repository public"
                fi
                echo "Repository URL: $GIT_REPO"
                exit 1
              }
            fi
            
            cd "$DEPLOY_PATH"
            
            # Проверяем, что это git репозиторий
            if [ ! -d ".git" ]; then
              echo "Error: $DEPLOY_PATH is not a git repository!"
              echo "Please ensure the directory exists and contains a git repository."
              exit 1
            fi
            
            echo "Pulling latest changes..."
            git fetch origin
            git reset --hard origin/main
            git clean -fd
            echo "Stopping containers..."
            docker-compose down
            echo "Building and starting containers..."
            docker-compose up -d --build
            echo "Checking container status..."
            docker-compose ps
            echo "Deployment completed successfully!"
