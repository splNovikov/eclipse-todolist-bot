name: Deploy to Timeweb Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          SSH_PORT: ${{ secrets.SSH_PORT || '22' }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ env.SSH_PORT }}
          script: |
            set -e
            DEPLOY_PATH="${{ secrets.SSH_DEPLOY_PATH }}"
            if [ -z "$DEPLOY_PATH" ]; then
              DEPLOY_PATH="$HOME/eclipse-todolist-bot"
            fi
            echo "Deploying to: $DEPLOY_PATH"
            if [ ! -d "$DEPLOY_PATH" ]; then
              echo "Error: Directory $DEPLOY_PATH does not exist!"
              exit 1
            fi
            cd "$DEPLOY_PATH"
            echo "Pulling latest changes..."
            git pull origin main
            echo "Stopping containers..."
            docker-compose down
            echo "Building and starting containers..."
            docker-compose up -d --build
            echo "Checking container status..."
            docker-compose ps
            echo "Deployment completed successfully!"
